<h2 class="mb-4">Bulk Report</h2>

<h3 class="mb-2 h5" [translate]="'select-granularity'"></h3>

<upd-dropdown
id="granularity"
[label]="granularityLabel"
[options]="granularityOptions"
[onSelect]="granularitySelect.bind(this)"
(selectedValueChange)="onGranularitySelect($event)"
>
</upd-dropdown>

<ng-container *ngIf="isGranularitySelected()">
<h3 class="mb-2 h5" [translate]="'select-date'"></h3>

<div *ngIf="validationTriggered && !isDateRangeValid()">
  <upd-alert [type]="'danger'" [dismissible]="false" [selfClosing]="false">
    <span class="material-icons align-top pe-1" aria-hidden="true">error</span>
    <span [translate]="'alert-date'"></span>
  </upd-alert>
</div>

<upd-calendar
  #calendar
  [showAction]="true"
  [showPreset]="true"
  (dateChange)="handleDateChange($event); resetValidation()"
  [granularity]="granularityValue"
  [required]="false"
></upd-calendar>
</ng-container>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col">
<h3 class="h5">Add pages:</h3>

<div *ngIf="validationTriggered && !areUrlsValid()">
  <upd-alert [type]="'danger'" [dismissible]="false" [selfClosing]="false">
    <span class="material-icons align-top pe-1" aria-hidden="true">error</span>
    <span [translate]="'alert-url'"></span>
  </upd-alert>
</div>

<div
  [title]="'Validation Results'"
  *ngIf="invalidUrls.length > 0 || duplicateUrls.length > 0 || successUrls.length > 0"
>
<div *ngIf="successUrls.length > 0">
  <upd-alert
    [type]="'success'"
    position="static"
    [dismissible]="true"
    [selfClosing]="true"
  >
    <span class="material-icons align-top pe-1" aria-hidden="true"
      >check</span
    >
    <span>Success URLs:</span>
    <ul>
      <li *ngFor="let url of successUrls">{{ url }}</li>
    </ul>
  </upd-alert>
</div>
  <div *ngIf="invalidUrls.length > 0">
    <upd-alert
      [type]="'danger'"
      [dismissible]="false"
      [selfClosing]="false"
      position="static"
    >
      <span class="material-icons align-top pe-1" aria-hidden="true"
        >error</span
      >
      <span>Invalid URLs:</span>
      <ul>
        <li *ngFor="let url of invalidUrls">{{ url }}</li>
      </ul>
    </upd-alert>
  </div>
  <div *ngIf="duplicateUrls.length > 0">
    <upd-alert
      [type]="'warning'"
      [dismissible]="true"
      [selfClosing]="false"
      position="static"
    >
      <span class="material-icons align-top pe-1" aria-hidden="true"
        >warning</span
      >
      <span>Duplicate URLs:</span>
      <ul>
        <li *ngFor="let url of duplicateUrls">{{ url }}</li>
      </ul>
    </upd-alert>
  </div>
</div>

<div class="card">
  <p-tabView styleClass="tabview-custom">
    <p-tabPanel>
      <ng-template pTemplate="header">
        <span class="material-icons" aria-hidden="true">content_paste</span>
        <span>Bulk Pages</span>
      </ng-template>
      <span class="p-float-label mt-3">
        <textarea
          pInputTextarea
          #urlTextarea
          rows="5"
          id="float-input"
          class="w-100"
        ></textarea>
        <label for="float-input"
          >Enter URLs separated by comma, semicolon or new lines</label
        >
      </span>
    </p-tabPanel>
    <p-tabPanel>
      <ng-template pTemplate="header">
        <span class="material-icons" aria-hidden="true">layers</span>
        <span>Pages</span>
      </ng-template>
      <upd-data-table
        #dataTable
        id="pages-home-"
        [data]="(pagesHomeData$ | async) || []"
        [cols]="columns"
        [displayRows]="5"
        [loading]="(loading$ | async) || false"
        placeholderText="dt_search_keyword_url"
        [searchFields]="searchFields"
        [exports]="false"
        [checkboxes]="true"
        (pageSelectionChanged)="handleSelectedPages($event)"
        [ngClass]="'pages-home'"
      >
      </upd-data-table>
    </p-tabPanel>
    <p-tabPanel>
      <ng-template pTemplate="header">
        <span class="material-icons" aria-hidden="true">assignment</span>
        <span>Tasks</span>
      </ng-template>
      <upd-data-table
        #tasksTable
        id="tasks-list-"
        [data]="(tasks$ | async) || []"
        [cols]="taskColumns"
        [displayRows]="5"
        [loading]="(loading$ | async) || false"
        [exports]="false"
        [checkboxes]="true"
        (pageSelectionChanged)="handleSelectedTasks($event)"
        [ngClass]="'tasks-list'"
      >
      </upd-data-table>
    </p-tabPanel>
    <p-tabPanel>
      <ng-template pTemplate="header">
        <span class="material-icons" aria-hidden="true">folder</span>
        <span>UX projects</span>
      </ng-template>
      <upd-data-table
        #projectsTable
        id="projects-list-"
        [data]="(projects$ | async) || []"
        [cols]="taskColumns"
        [displayRows]="5"
        [loading]="(loading$ | async) || false"
        [exports]="false"
        [checkboxes]="true"
        (pageSelectionChanged)="handleSelectedProjects($event)"
        [ngClass]="'projects-list'"
      >
      </upd-data-table>
    </p-tabPanel>
  </p-tabView>

  <button
    class="btn btn-success"
    (click)="
      addPages(urlTextarea.value); resetTableSelection(); resetValidation()
    "
  >
    Add pages and validate
  </button>
</div>
</div>
</div>
</div>
<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col">
<upd-accordion
  #urlsAdded
  [styleClass]="'mb-2'"
  *ngIf="urlsCount > 0"
  [expanded]="isAccordionExpanded"
  title="{{ 'URLs added to report' | translate: { count: urlsCount || 0 } }} "
>
  <div class="container">
    <div class="row">
      <div class="col p-0">
        <ng-container *ngFor="let url of urls; let i = index">
          <span class="badge-blue">
            <a
              href="{{ 'https://' + url }}"
              (click)="openLink($event, 'https://' + url)"
              class="p-1 align-text-top"
              placement="top"
              >{{ url }}</a
            >
            <button
              type="button"
              class="btn-close btn-close-white mt-1 me-1"
              aria-label="Close"
              (click)="removePage(i); resetValidation()"
            ></button
          ></span>
        </ng-container>
      </div>
    </div>
  </div>
</upd-accordion>
</div>
</div>
</div>

<upd-input-switch
  id="group"
  [(checked)]="isGrouped"
  [text]="'Group pages as segment'"
  (checkedChange)="updateConfig(); resetValidation()"
></upd-input-switch>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col-6">
      <div *ngIf="validationTriggered && !areMetricsValid()">
        <upd-alert
          [type]="'danger'"
          [dismissible]="false"
          [selfClosing]="false"
        >
          <span class="material-icons align-top pe-1" aria-hidden="true"
            >error</span
          >
          <span [translate]="'alert-metric'"></span>
        </upd-alert>
      </div>
      <h3 class="h5">Select metrics:</h3>

      <upd-checkbox
        [id]="'metrics'"
        [items]="reportMetrics"
        [(selectedItems)]="selectedReportMetrics"
        (selectedItemsChange)="updateConfig(); resetValidation()"
      >
      </upd-checkbox>
    </div>
  </div>
</div>

<div class="container-fluid my-4 gx-0">
  <div class="row">
    <div class="col-6">
      <h3 class="h5">Select a dimension for breakdown:</h3>

      <upd-radio
        [id]="'dimensions'"
        [items]="reportDimensions"
        [(selectedItems)]="selectedReportDimensions"
        (selectedItemsChange)="updateConfig(); resetValidation()"
      >
      </upd-radio>
    </div>
  </div>
</div>


  <button class="btn btn-primary" (click)="generateAndDownloadReport()">
    Generate and download report
  </button>

  <div class="box box-default">
    <code>
      <pre>{{ displayConfig }}</pre>
    </code>
  </div>
